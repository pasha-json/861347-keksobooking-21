(()=>{"use strict";!function(){const e=document.querySelector(".ad-form"),o=document.querySelector(".map"),t=o.querySelector(".map__filters"),n=document.querySelector(".map__pin--main"),i=document.querySelector("#address");window.nodes={adForm:e,mapBlock:o,filtersForm:t,mainPinButton:n,accomodationAddress:i}}(),(()=>{const e=(e,o=1)=>Math.round(e.offsetWidth/o),o=(e,o=1)=>Math.round(e.offsetHeight/o),t=()=>{const e=document.querySelector(".popup");e&&(e.remove(),window.pins.removeActiveClass(),document.removeEventListener("keydown",n))},n=e=>{"Escape"===e.key&&(e.preventDefault(),t())};window.utils={cloneElement:e=>e.cloneNode(!0),getShiftX:e,getShiftY:o,onPopUpEscPress:n,closePopup:t,calculateCoords:()=>{const t=e(window.nodes.mainPinButton,2),n=o(window.nodes.mainPinButton)+18,i=-t,d=window.nodes.mapBlock.offsetWidth-t,s=130-n,r=630-n;window.nodes.mainPinButton.offsetTop-window.utils.shift.y>r?window.nodes.mainPinButton.style.top=r+"px":window.nodes.mainPinButton.offsetTop-window.utils.shift.y<s?window.nodes.mainPinButton.style.top=s+"px":window.nodes.mainPinButton.style.top=window.nodes.mainPinButton.offsetTop-window.utils.shift.y+"px",window.nodes.mainPinButton.offsetLeft-window.utils.shift.x>d?window.nodes.mainPinButton.style.left=d+"px":window.nodes.mainPinButton.offsetLeft-window.utils.shift.x<i?window.nodes.mainPinButton.style.left=i+"px":window.nodes.mainPinButton.style.left=window.nodes.mainPinButton.offsetLeft-window.utils.shift.x+"px";let a=window.nodes.mainPinButton.offsetLeft-window.utils.shift.x+t,u=window.nodes.mainPinButton.offsetTop-window.utils.shift.y+n;a<0?a=0:a>window.nodes.mapBlock.offsetWidth&&(a=window.nodes.mapBlock.offsetWidth),u<130?u=130:u>630&&(u=630),window.nodes.accomodationAddress.setAttribute("value",` ${a}, ${u}`)},showErrorMessage:e=>{const o=document.createElement("div");o.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",o.style.position="absolute",o.style.left=0,o.style.right=0,o.style.fontSize="30px",o.textContent=e,document.body.insertAdjacentElement("afterbegin",o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],o=(o,t,n=!1)=>{const i=window.nodes.adForm.querySelector(""+o),d=window.nodes.adForm.querySelector(""+t);i.addEventListener("change",(function(){const o=i.files[0],t=o.name.toLowerCase();if(e.some((e=>t.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n&&(d.style.backgroundSize="cover",d.style.backgroundImage=`url(${e.result})`),d.src=e.result})),e.readAsDataURL(o)}}))};o("#avatar",".ad-form-header__preview > img"),o("#images",".ad-form__photo",!0)})(),(()=>{const e="GET",o="POST",t=(e,o,t)=>{e.responseType="json",e.addEventListener("load",(function(){200!==e.status?t("Статус ответа: "+e.status+" "+e.statusText):o(e.response)})),e.addEventListener("error",(function(){t("Произошла ошибка соединения")})),addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+e.timeout+"мс")}))};window.load={downloadData:(o,n)=>{const i=new XMLHttpRequest;t(i,o,n),i.timeout=1e4,i.open(e,"https://21.javascript.pages.academy/keksobooking/data"),i.send()},uploadData:(e,n,i)=>{const d=new XMLHttpRequest;t(d,n,i),d.open(o,"https://21.javascript.pages.academy/keksobooking"),d.send(e)}}})(),window.debounce=e=>{let o=null;return(...t)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...t)}),500)}},(()=>{const e=window.nodes.mapBlock.querySelector(".map__filters"),o=e.querySelector("#housing-type"),t=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),i=e.querySelector("#housing-guests"),d=()=>{const d=window.pins.houses.sortedHouses.filter((e=>"any"===o.value||e.offer.type===o.value)).filter((e=>"any"===t.value||("low"===t.value?e.offer.price<=1e4:"middle"===t.value?e.offer.price>=1e4&&e.offer.price<=5e4:e.offer.price>=5e4))).filter((e=>"any"===n.value||e.offer.rooms===Number(n.value))).filter((e=>"any"===i.value||"0"!==i.value&&e.offer.guests>=Number(i.value))).filter((o=>{const t=e.querySelectorAll("input:checked");return Array.from(t).every((function(e){return o.offer.features.includes(e.value)}))})).slice(0,5);return window.filter.filteredHouses={filteredHouses:d},d};e.addEventListener("change",window.debounce((function(){window.pins.removePins(),window.utils.closePopup(),window.pins.renderPins(d())}))),window.filter={updatePins:d}})(),(()=>{const e=document.querySelector(".map__pins"),o=document.querySelector("#pin").content,t=document.querySelector(".map__pin"),n=window.utils.getShiftX(t,2),i=window.utils.getShiftY(t);window.load.downloadData((e=>{const o=e.filter((e=>e.hasOwnProperty("offer")));window.pins.houses={sortedHouses:o}}),(e=>{window.utils.showErrorMessage(e)}));const d=()=>{const e=Array.from(window.nodes.mapBlock.querySelectorAll(".map__pin"));return e.shift(),e};window.pins={removePins:()=>{d().forEach((e=>{e.remove()}))},renderPins:t=>{for(let d=0;d<t.length;d++){const s=window.utils.cloneElement(o),r=s.querySelector("img"),a=s.querySelector("button");a.style=`left:${t[d].location.x-n}px; top:${t[d].location.y-i}px;`,r.src=""+t[d].author.avatar,r.alt=""+t[d].offer.title,a.addEventListener("click",(()=>{window.utils.closePopup(),a.classList.toggle("map__pin--active"),window.card.fillCard(d)})),e.appendChild(s)}},removeActiveClass:()=>{d().forEach((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")}))},onPinMouseDown:e=>{if(0===e.button){e.preventDefault();let o={x:e.clientX,y:e.clientY},t=!1;const n=e=>{e.preventDefault(),t=!0,window.utils.shift={x:o.x-e.clientX,y:o.y-e.clientY},o={x:e.clientX,y:e.clientY},window.utils.calculateCoords()},i=e=>{if(e.preventDefault(),window.nodes.mapBlock.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i),t){const e=o=>{o.preventDefault(),window.utils.calculateCoords(),window.nodes.mainPinButton.removeEventListener("click",e)};window.nodes.mainPinButton.addEventListener("click",e)}};window.nodes.mapBlock.addEventListener("mousemove",n),document.addEventListener("mouseup",i)}}}})(),window.nodes.mainPinButton.addEventListener("mousedown",window.pins.onPinMouseDown),window.card={fillCard:(e=0)=>{const o=window.filter.filteredHouses.filteredHouses[e],t=document.querySelector("#card").content,n=window.utils.cloneElement(t),i=n.querySelector(".popup__title"),d=n.querySelector(".popup__text--address"),s=n.querySelector(".popup__text--price"),r=n.querySelector(".popup__type"),a=n.querySelector(".popup__text--capacity"),u=n.querySelector(".popup__text--time"),c=n.querySelector(".popup__description"),l=n.querySelector(".popup__photos"),w=l.querySelector("img"),m=n.querySelector(".popup__avatar"),f=n.querySelector(".popup__close");if(i.textContent=o.offer.title,d.textContent=o.offer.address,s.textContent=o.offer.price+"₽/ночь",r.textContent=""+{flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"}[o.offer.type],a.textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,u.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,c.textContent=""+o.offer.description,m.src=""+o.author.avatar,w.src=o.offer.photos[0],o.offer.photos.length>1)for(let e=1;e<o.offer.photos.length;e++){const t=w.cloneNode(!0);t.src=o.offer.photos[e],l.appendChild(t)}const p=n.querySelector(".popup__features").children;for(let e=0;e<p.length;e++)p[e].classList.add("hidden");for(let e=0;e<o.offer.features.length;e++)n.querySelector(".popup__feature--"+o.offer.features[e]).classList.remove("hidden");const v=(e,t,n)=>{!1!==o[e].hasOwnProperty(""+t)&&0!==o[e][t].length||n.classList.add("hidden")};v("offer","title",i),v("offer","address",d),v("offer","price",s),v("offer","type",r),v("offer","price",s),v("offer","rooms",a),v("offer","guests",a),v("offer","checkin",u),v("offer","checkout",u),v("offer","description",c),v("author","avatar",m),v("offer","photos",w);const y=window.nodes.mapBlock.querySelector(".map__filters-container");window.nodes.mapBlock.insertBefore(n,y),document.addEventListener("keydown",window.utils.onPopUpEscPress),f.addEventListener("click",window.utils.closePopup)}},(()=>{const e=+/\d+/.exec(window.nodes.mainPinButton.style.left),o=+/\d+/.exec(window.nodes.mainPinButton.style.top),t=window.nodes.mainPinButton.offsetHeight/2+22,n=window.utils.getShiftX(window.nodes.mainPinButton,2),i=window.utils.getShiftY(window.nodes.mainPinButton,2),d=Math.round(window.nodes.mainPinButton.offsetLeft+n),s=Math.round(window.nodes.mainPinButton.offsetTop+i),r=document.querySelector(".ad-form").children,a=document.querySelector(".map__filters").children,u=Array.from(r),c=Array.from(a),l=()=>{window.nodes.adForm.reset(),window.nodes.filtersForm.reset(),window.nodes.adForm.classList.add("ad-form--disabled"),window.nodes.mapBlock.classList.add("map--faded"),window.pins.removePins(),window.utils.closePopup();const t=e=>e.setAttribute("disabled",!0);u.forEach((e=>{t(e)})),c.forEach((e=>{t(e)})),window.nodes.mainPinButton.style.left=e+"px",window.nodes.mainPinButton.style.top=o+"px",window.nodes.accomodationAddress.setAttribute("value",`${d}, ${s}`),window.nodes.mainPinButton.addEventListener("mousedown",window.page.onMainPinButtonLeftClick),window.nodes.mainPinButton.addEventListener("keydown",window.page.onMainPinButtonEnterPress)};document.addEventListener("DOMContentLoaded",l);const w=()=>{const e=e=>e.removeAttribute("disabled");u.forEach((o=>{e(o)})),c.forEach((o=>{e(o)}));try{window.pins.renderPins(window.filter.updatePins())}catch(e){window.utils.showErrorMessage("Упс! Ошибка"+e.name+". Обновите страницу и попробуйте ещё раз!")}window.nodes.mapBlock.classList.remove("map--faded");const o=Math.round(d+0),n=Math.round(s+t);window.nodes.accomodationAddress.setAttribute("value",`${o}, ${n}`),window.nodes.adForm.classList.remove("ad-form--disabled"),window.nodes.adForm.querySelector("#address").setAttribute("readonly","readonly"),document.removeEventListener("DOMContentLoaded",l),window.nodes.mainPinButton.removeEventListener("mousedown",m),window.nodes.mainPinButton.removeEventListener("keydown",f)},m=e=>{0===e.button&&w()},f=e=>{"Enter"===e.key&&w()};window.nodes.mainPinButton.addEventListener("mousedown",m),window.nodes.mainPinButton.addEventListener("keydown",f),window.page={activatePage:w,deactivatePage:l,onMainPinButtonLeftClick:m,onMainPinButtonEnterPress:f}})(),(()=>{const e=window.nodes.adForm.querySelector("#room_number"),o=window.nodes.adForm.querySelector("#capacity"),t=window.nodes.adForm.querySelector("#type"),n=window.nodes.adForm.querySelector("#price"),i=window.nodes.adForm.querySelector("#timein"),d=window.nodes.adForm.querySelector("#timeout");d.addEventListener("change",(()=>{i.value=d.value})),window.nodes.adForm.addEventListener("submit",(e=>{window.load.uploadData(new FormData(window.nodes.adForm),(()=>{window.page.deactivatePage();const e=document.querySelector("#success").content.cloneNode(!0);window.nodes.mapBlock.appendChild(e);const o=document.querySelector(".success"),t=e=>{"Escape"===e.key&&(e.preventDefault(),o.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",n))},n=e=>{e.preventDefault(),o.remove(),document.removeEventListener("click",n),document.removeEventListener("keydown",t)};document.addEventListener("keydown",t),document.addEventListener("click",n)}),(()=>{const e=document.querySelector("#error").content.cloneNode(!0);document.querySelector("main").appendChild(e);const o=document.querySelector(".error__button"),t=document.querySelector(".error"),n=e=>{e.preventDefault(),t.remove(),o.removeEventListener("click",n),document.removeEventListener("keydown",i),document.removeEventListener("click",d)},i=e=>{"Escape"===e.key&&(e.preventDefault(),t.remove(),document.removeEventListener("keydown",i),o.removeEventListener("click",n),document.removeEventListener("click",d))},d=e=>{e.preventDefault(),t.remove(),document.removeEventListener("click",d),document.removeEventListener("keydown",i),o.removeEventListener("click",n)};o.addEventListener("click",n),document.addEventListener("keydown",i),document.addEventListener("click",d)})),e.preventDefault()})),window.nodes.adForm.querySelector(".ad-form__reset").addEventListener("click",(()=>{window.page.deactivatePage()})),window.form={validateForm:()=>{const s=Number(e.value),r=Number(o.value);s>3&&0!==r?o.setCustomValidity("Сто комнат — только не для гостей"):0===r&&s<=3?o.setCustomValidity("Не для гостей только 100 комнат"):s<r?o.setCustomValidity("Каждая комната вмещает только одного гостя"):o.setCustomValidity(""),"bungalo"===t.value?(n.setCustomValidity(""),n.placeholder=0):"flat"===t.value&&n.value<1e3?(n.setCustomValidity("Минимальная стоимость квартиры — 1000 ₽"),n.placeholder=1e3):"house"===t.value&&n.value<5e3?(n.setCustomValidity("Минимальная стоимость дома — 5000 ₽"),n.placeholder=5e3):"palace"===t.value&&n.value<1e4?(n.setCustomValidity("Минимальная стоимость дворца — 10000 ₽"),n.placeholder=1e4):n.value>1e6?n.setCustomValidity("Максимальная цена за ночь: 1000000"):n.setCustomValidity(""),i.value!==d.value&&(d.value=i.value)}}})(),window.nodes.adForm.addEventListener("change",window.form.validateForm)})();